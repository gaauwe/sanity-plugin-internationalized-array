"use strict";function e(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function n(n){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?e(Object(i),!0).forEach((function(e){t(n,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(i,e))}))}return n}function t(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}Object.defineProperty(exports,"__esModule",{value:!0});var r=require("suspend-react"),i=require("react/jsx-runtime"),l=require("sanity"),a=require("react"),o=require("lodash"),s=require("@sanity/ui"),u=require("@sanity/icons"),d=require("fast-deep-equal");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function g(e){if(e&&e.__esModule)return e;var n=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})}})),n.default=e,Object.freeze(n)}var p=g(r),y=c(a),f=c(d);const h="sanity-plugin-internationalized-array",m=e=>p.peek(["v0",h,e]);var v=a.memo((function(e){const n=l.useClient({apiVersion:e.apiVersion});var t;return Array.isArray(m({}))||(t=async()=>Array.isArray(e.languages)?e.languages:e.languages(n,{}),p.preload((()=>t()),["v0",h])),null}));function j(e){return function(e){return e.split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" ")}(function(e){return e.replace(/-([a-z])/g,(e=>e[1].toUpperCase()))}(e))}function b(e){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return n?["internationalizedArray",j(e),"Value"].join(""):["internationalizedArray",j(e)].join("")}const x=(e,n)=>{if(!e||!n)return{};const t=e||{};return Object.keys(t).reduce(((e,r)=>(e[r]=o.get(n,t[r]),e)),{})},k={languages:[{id:"en",title:"English"},{id:"no",title:"Norsk"}]};function O(){return i.jsx(s.Card,{tone:"caution",border:!0,radius:2,padding:3,children:i.jsxs(s.Stack,{space:4,children:[i.jsxs(s.Text,{children:["An array of language objects must be passed into the ",i.jsx("code",{children:"internationalizedArray"})," ","helper function, each with an ",i.jsx("code",{children:"id"})," and ",i.jsx("code",{children:"title"})," field. Example:"]}),i.jsx(s.Card,{padding:2,border:!0,radius:2,children:i.jsx(s.Code,{size:1,language:"javascript",children:JSON.stringify(k,null,2)})})]})})}const _=y.default.createContext({languages:[]}),C=_.Provider;function A(e){const{members:t,value:o,schemaType:d,onChange:c}=e,g="boolean"==typeof d.readOnly&&d.readOnly,{options:p}=d,y=s.useToast(),{value:m}=l.useFormBuilder(),v=x(p.select,m),{apiVersion:j}=p,b=l.useClient({apiVersion:j}),k=Array.isArray(p.languages)?p.languages:r.suspend((async()=>"function"==typeof p.languages?p.languages(b,v):p.languages),["v0",h,v],{equal:f.default}),_=a.useCallback((e=>{if(!(null==k?void 0:k.length))return;const t={_type:"".concat(d.name,"Value")},r=e?[n(n({},t),{},{_key:e})]:k.filter((e=>!(null==o?void 0:o.length)||!o.find((n=>n._key===e.id)))).map((e=>n(n({},t),{},{_key:e.id}))),i=(null==o?void 0:o.length)?o.map((e=>e)):[],a=r.map((e=>{const n=k.findIndex((n=>e._key===n.id)),t=k.slice(n+1),r=i.findIndex((e=>t.find((n=>n.id===e._key))));return r<0?i.push(e):i.splice(r,0,e),r<0?l.insert([e],"after",[r]):l.insert([e],"before",[r])}));c([l.setIfMissing([]),...a])}),[k,c,d.name,o]),A=a.useCallback((()=>{if(!(null==o?void 0:o.length)||!(null==k?void 0:k.length))return;const e=o.reduce(((e,n)=>{const t=k.findIndex((e=>e.id===(null==n?void 0:n._key)));return t>-1&&(e[t]=n),e}),[]).filter(Boolean);(null==o?void 0:o.length)!==e.length&&y.push({title:"There was an error reordering languages",status:"warning"}),c(l.set(e))}),[y,k,c,o]),P=a.useMemo((()=>!(null==o?void 0:o.length)||!(null==k?void 0:k.length)||(null==o?void 0:o.every((e=>k.find((n=>(null==n?void 0:n.id)===(null==e?void 0:e._key))))))),[o,k]),I=a.useMemo((()=>k&&k.length>1?k.filter((e=>null==o?void 0:o.find((n=>n._key===e.id)))):[]),[k,o]),w=a.useMemo((()=>(null==o?void 0:o.length)&&I.length?o.map(((e,n)=>n===I.findIndex((n=>n.id===e._key))?null:e)).filter(Boolean):[]),[o,I]),z=a.useMemo((()=>!(null==k?void 0:k.length)||(null==k?void 0:k.length)&&k.every((e=>e.id&&e.title))),[k]);return a.useEffect((()=>{w.length>0&&P&&A()}),[w,P,A]),z?i.jsx(C,{value:{languages:k},children:i.jsxs(s.Stack,{space:2,children:[(null==t?void 0:t.length)>0?i.jsx(i.Fragment,{children:t.map((n=>"item"===n.kind?i.jsx(l.ArrayOfObjectsItem,{member:n,renderItem:e.renderItem,renderField:e.renderField,renderInput:e.renderInput,renderPreview:e.renderPreview},n.key):null))}):null,(null==k?void 0:k.length)>0&&I.length<k.length?i.jsxs(s.Stack,{space:2,children:[k.length>1?i.jsx(s.Grid,{columns:Math.min(k.length,5),gap:2,children:k.map((e=>i.jsx(s.Button,{tone:"primary",mode:"ghost",fontSize:1,disabled:g||Boolean(null==o?void 0:o.find((n=>n._key===e.id))),text:e.id.toUpperCase(),icon:u.AddIcon,onClick:()=>_(e.id)},e.id)))}):null,i.jsx(s.Button,{tone:"primary",mode:"ghost",disabled:g||o&&(null==o?void 0:o.length)>=(null==k?void 0:k.length),icon:u.AddIcon,text:(null==o?void 0:o.length)?"Add missing ".concat(k.length-o.length==1?"language":"languages"):1===k.length?"Add ".concat(k[0].title," Field"):"Add all languages",onClick:()=>_()})]}):null]})}):i.jsx(O,{})}var P=e=>{const{apiVersion:t,select:r,languages:i,type:a}=e,o="string"==typeof a?a:a.name,s=b(o),u=b(o,!0);return l.defineField({name:s,title:"Internationalized array",type:"array",components:{input:A},options:{apiVersion:t,select:r,languages:i},of:[l.defineField(n(n({},"string"==typeof a?{}:a),{},{name:u,type:u}))],validation:e=>e.custom((async(e,i)=>{var l,a,o;if(!e)return!0;const s=x(r,i.document),u=i.getClient({apiVersion:t}),d=Array.isArray(null==(a=null==(l=null==i?void 0:i.type)?void 0:l.options)?void 0:a.languages)?i.type.options.languages:Array.isArray(m(s))?m(s):await(null==(o=null==i?void 0:i.type)?void 0:o.options.languages(u,s));if(e&&e.length>d.length)return"Cannot be more than ".concat(1===d.length?"1 item":"".concat(d.length," items"));const c=(null==e?void 0:e.length)?e.filter((e=>!d.find((n=>e._key===n.id)))):[];if(c.length)return{message:"Array item keys must be valid languages registered to the field type",paths:c.map((e=>[{_key:e._key}]))};const g=(null==e?void 0:e.length)?e.filter((e=>Boolean(null==e?void 0:e._key))).reduce(((e,t)=>e[t._key]?n(n({},e),{},{[t._key]:[...e[t._key],t]}):n(n({},e),{},{[t._key]:[t]})),{}):{},p=Object.values(g).filter((e=>(null==e?void 0:e.length)>1)).flat();return!p.length||{message:"There can only be one field per language",paths:p.map((e=>[{_key:e._key}]))}}))})};function I(e){return"reference"===e.schemaType.name&&e.value?e.renderDefault(n(n({},e),{},{title:"",level:0})):e.children}function w(e){if(!(null==e?void 0:e.length))return;const n=e.map((e=>e.level));return n.includes("error")?"critical":n.includes("warning")?"caution":void 0}function z(e){const t=l.useFormValue(e.path.slice(0,-1)),r=n(n({},e.inputProps),{},{members:e.inputProps.members.filter((e=>"field"===e.kind&&"value"===e.name)),value:e.value}),{validation:o,value:d,onChange:c,readOnly:g}=r,{languages:p}=y.default.useContext(_),f=a.useMemo((()=>{var e;return null!=(e=null==t?void 0:t.map((e=>e._key)))?e:[]}),[t]),h=!!(null==p?void 0:p.length)&&p.find((e=>e.id===d._key)),m=a.useCallback((e=>{d&&(null==p?void 0:p.length)&&p.find((n=>n.id===e))&&c([l.set(e,["_key"])])}),[c,d,p]),v=a.useCallback((()=>{c(l.unset())}),[c]);return p?i.jsx(s.Card,{paddingTop:2,tone:w(o),children:i.jsxs(s.Stack,{space:2,children:[i.jsx(s.Card,{tone:"inherit",children:h?i.jsx(s.Label,{muted:!0,size:1,children:d._key}):i.jsx(s.MenuButton,{button:i.jsx(s.Button,{fontSize:1,text:'Change "'.concat(d._key,'"')}),id:"".concat(d._key,"-change-key"),menu:i.jsx(s.Menu,{children:p.map((e=>i.jsx(s.MenuItem,{disabled:f.includes(e.id),fontSize:1,text:e.id.toLocaleUpperCase(),onClick:()=>m(e.id)},e.id)))}),placement:"right",popover:{portal:!0}})}),i.jsxs(s.Flex,{align:"center",gap:2,children:[i.jsx(s.Card,{flex:1,tone:"inherit",children:e.inputProps.renderInput(e.inputProps)}),i.jsx(s.Card,{tone:"inherit",children:i.jsx(s.Button,{mode:"bleed",icon:u.RemoveCircleIcon,tone:"critical",disabled:g,onClick:v})})]})]})}):i.jsx(s.Spinner,{})}var V=e=>{const{type:t}=e,r=b("string"==typeof t?t:t.name,!0);return l.defineField({name:r,title:"Internationalized array ".concat(t),type:"object",components:{item:z},fields:["string"==typeof t?l.defineField({name:"value",type:t,components:{field:I}}):n(n({},t),{},{name:"value",components:{field:I}})],preview:{select:{title:"value",subtitle:"_key"}}})};const F={languages:[],fieldTypes:[]},M=l.definePlugin((function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:F;const{apiVersion:t="2022-11-27",select:r,languages:l,fieldTypes:a}=n(n({},F),e);return{name:"sanity-plugin-internationalized-array",studio:Array.isArray(l)?void 0:{components:{layout:e=>i.jsxs(i.Fragment,{children:[i.jsx(v,{apiVersion:t,languages:l}),e.renderDefault(e)]})}},schema:{types:[...a.map((e=>P({type:e,apiVersion:t,select:r,languages:l}))),...a.map((e=>V({type:e})))]}}}));exports.clear=()=>p.clear(["v0",h]),exports.internationalizedArray=M;
//# sourceMappingURL=index.js.map
